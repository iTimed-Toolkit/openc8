#include "dev_globals.h"
#include "dev_util.h"
#include "bootrom_func.h"

#define NUM_HANDLERS    32

GLOBAL_STR(inst_string, "installer");
GLOBAL_STR(stat_string, "status");
GLOBAL_STR(read_string, "read");
GLOBAL_STR(write_string, "write");
GLOBAL_STR(exec_string, "execute");

GLOBAL_PTR(installed_handlers, 0);
GLOBAL_INT(num_installed, 0);

GLOBAL_PTR(addr_dfu_img_base, ADDR_DFU_IMG_BASE);

PAYLOAD_SECTION
int install_handler(void *arg)
{
    struct install_info *info = (struct install_info *) arg;
    struct install_info *handlers = GET_GLOBAL(installed_handlers);
    void *addr, *dest;

    if(GET_GLOBAL(num_installed) == NUM_HANDLERS)
        return -1;

    dev_memcpy(&handlers[GET_GLOBAL(num_installed)].name,
               &info->name, INSTALL_NAME_SZ);

    if(info->len)
    {
        addr = dev_malloc(info->len);
        dest = (void *) GET_GLOBAL(addr_dfu_img_base) + sizeof(struct install_info);
        dev_memcpy(addr, dest, info->len);

        handlers[GET_GLOBAL(num_installed)].len = info->len;
        handlers[GET_GLOBAL(num_installed)].handler = addr;
    }
    else
    {
        handlers[GET_GLOBAL(num_installed)].len = -1;
        handlers[GET_GLOBAL(num_installed)].handler = info->handler;
    }

    SET_GLOBAL(num_installed, GET_GLOBAL(num_installed) + 1);
    return GET_GLOBAL(num_installed);
}

PAYLOAD_SECTION
int handle_intf_req_wrap(struct usb_request *req, void **out)
{
    return handle_intf_req(req, out);
}

PAYLOAD_SECTION
void install(char *name, int (*handler)(void *))
{
    struct install_info info;
    dev_memcpy(&info.name, name, dev_strlen(name));
    info.handler = handler;

    install_handler(&info);
}

PAYLOAD_SECTION
int handle(struct usb_request *req)
{
    int retval = 0, h = 0xFFFF - req->wValue;
    struct install_info *handlers;
    void *p_inst_handler;

    if(GET_GLOBAL(num_installed) == 0)
    {
        handlers = dev_malloc(NUM_HANDLERS * sizeof(struct install_info));
        SET_GLOBAL(installed_handlers, handlers);

        __asm__ volatile ("adr %0, install_handler" : "=r" (p_inst_handler));
        install(GET_PTR_TO_GLOBAL(inst_string), p_inst_handler);

        SET_GLOBAL(num_installed, 1);
    }
    else
        handlers = GET_GLOBAL(installed_handlers);

    if(h < GET_GLOBAL(num_installed))
        retval = handlers[h].handler(GET_GLOBAL(addr_dfu_img_base));

    usb_core_do_io(0x80, GET_GLOBAL(addr_dfu_img_base), req->wLength, 0);
    return retval;
}