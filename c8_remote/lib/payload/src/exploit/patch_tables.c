#include "dev_util.h"
#include "bootrom_func.h"

GLOBAL_LONG(rom_base, 0x100000000)
GLOBAL_LONG(rom_size, 0x2000000)

GLOBAL_LONG(sram_base, 0x180000000)
GLOBAL_LONG(sram_size, 0x2000000)

GLOBAL_CHAR(cont, 1)

PAYLOAD_SECTION
void run()
{
    uint64_t rom_base = GET_GLOBAL(rom_base),
            rom_size = GET_GLOBAL(rom_size),
            sram_base = GET_GLOBAL(sram_base),
            sram_size = GET_GLOBAL(sram_size);

    // rw permissions for rom
    map_range(WRITEABLE_ROM(rom_base), rom_base, rom_size, normal_rw);

    // rx permissions for sram
    map_range(EXECUTABLE_SRAM(sram_base), sram_base, sram_size, normal_rx);

    // checkra1n permissions as well todo: remove
    map_range(CR_EXECUTABLE_SRAM(sram_base), sram_base, sram_size, normal_rx);
    map_range(CR_WRITEABLE_SRAM(sram_base), sram_base, sram_size, normal_rw);

    // also demote here, so we can analyze all parts of exploit
    uint32_t *demote = (uint32_t *) ADDR_DEMOTE_REG;
    *demote = (*demote & 0xFFFFFFFE);
}

void _start()
{
    run();
}