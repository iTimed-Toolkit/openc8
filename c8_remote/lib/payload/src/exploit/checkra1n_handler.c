#include "dev_util.h"
#include "bootrom_func.h"

PAYLOAD_SECTION
void run()
{
    void (*get_img_usb)(uint64_t *, uint32_t) = (void *) ADDR_GET_IMG_USB;
    void (*execute_img)() = (void *) EXECUTABLE_SRAM(ADDR_DFU_IMG_BASE);

    get_img_usb(ADDR_DFU_IMG_BASE, 0x1000);
    __asm__ volatile ("dmb sy");
    __asm__ volatile ("ic iallu");
    __asm__ volatile ("dsb sy");
    __asm__ volatile ("isb");
//    __asm__ volatile ("b 0");

    // here, control passes to PAYLOAD_CHECKRA1N_STAGE2
    execute_img();
}

void _start()
{
    run();
}